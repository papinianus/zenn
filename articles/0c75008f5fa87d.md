---
title: 'Pleasanter x Google é€£æº:ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ãƒ‡ãƒ¼ã‚¿ã‚’å–ã‚Šè¾¼ã‚€'
emoji: 'ğŸŠ'
type: 'tech' # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ['googlespreadsheet', 'pleasanter']
published: true
---

[2022 å€‹äººã‚¢ãƒ‰ãƒ™ãƒ³ãƒˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼](https://qiita.com/advent-calendar/2022/papinianus) ã®è¨˜äº‹ã§ã™ã€‚

## ã‚´ãƒ¼ãƒ«

- Pleasanter ã®å¤–éƒ¨é€£æºã¨ã—ã¦ Google SpreadSheet ã¨ç¹‹ãè¾¼ã¿ã‚’è€ƒãˆã‚‹
- ã¾ãšã¯ã€ãƒ‡ãƒ¼ã‚¿ã‚’å–ã‚Šè¾¼ã‚€åŸºæœ¬å‡¦ç†ã‚’ãŠã•ãˆã‚‹

## é€£æºæ–¹æ³•ã®æ¤œè¨

Pleasanter ãŒå¤–éƒ¨é€£æºã™ã‚‹ã¨ã

1. å¤–éƒ¨ã‚·ã‚¹ãƒ†ãƒ å´ã‹ã‚‰ Pleasanter ã«å–ã‚Šã«æ¥ã‚‹
2. Pleasanter ã‹ã‚‰é€ã‚Šå‡ºã™

ã® 2 ã¤ã®æ–¹æ³•ãŒè€ƒãˆã‚‰ã‚Œã¾ã™ã€‚

### ä½¿ã„åˆ†ã‘ã‚’ã©ã†è€ƒãˆã‚‹ã‹

ã©ã¡ã‚‰ã®æ–¹æ³•ã‚’ä½¿ã†ã‹ã¯

- æ¨©é™ã®å•é¡Œ
- å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°

ã® 2 ã¤ã‹ã‚‰è€ƒãˆã‚‹ã®ãŒé©åˆ‡ã ã¨æ€ã„ã¾ã™ã€‚

ã¤ã¾ã‚Š

- å¤–éƒ¨ã‚·ã‚¹ãƒ†ãƒ å´ã®æ¨©é™ãŒã©ã®ã‚ˆã†ã§èª°ãŒå®Ÿè¡Œã—ãŸã“ã¨ã«ãªã‚‹ã‹
- Pleasater å´ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒã©ã®ç¯„å›²ã§ä¸ãˆã‚‰ã‚Œã‚‹ã‹

ã¨ã€

- ãƒ€ãƒ³ãƒ—çš„ã«æ–­é¢ã§å–ã‚‹ã‹
- å·®åˆ†ã®ç™ºç”Ÿã«å¿œã˜ãŸã‚¤ãƒ™ãƒ³ãƒˆã§å®Ÿè¡Œã™ã‚‹ã‹

ã®ä¸¡é¢ãŒè€ƒæ…®è¦ç´ ã¨ãªã‚Šã¾ã™ã€‚
ç‰¹ã«ç¾æ™‚ç‚¹ã§ã¯ Pleasanter ã«ã¯ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å®šæ™‚å®Ÿè¡Œã®æ©Ÿèƒ½ãŒãªãã€ã‚¹ã‚¯ãƒªãƒ—ãƒˆå‡¦ç†ã¯ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•ã¨ãªã‚‹ã“ã¨ã€ã¾ãŸä»®ã«ä»Šå¾Œå®šæ™‚å®Ÿè¡Œæ©Ÿèƒ½ãŒã§ããŸã¨ã—ã¦ã‚‚ãƒ¦ãƒ¼ã‚¶ã®ã€Œç·¨é›†ã€ã‚’ãƒˆãƒªã‚¬ãƒ¼ã¨ã—ãŸã€ãã®å ´ãã®å ´ã§ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¯ã€ãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›ã—ã¦ã„ã‚‹å´ã§ç›£è¦–ã™ã‚‹ã®ãŒå¦¥å½“ã¨è€ƒãˆã‚‰ã‚Œã¾ã™ã€‚

### æœ¬è¨˜äº‹ã§ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ

ã¨ã„ã†ã“ã¨ã§ã€æŠ€è¡“çš„ã«ã¯ Pleasanter ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ã‚‚ã€å¤–éƒ¨ã‚·ã‚¹ãƒ†ãƒ å´ã§ã‚‚è‡ªç”±ã«ã‚³ãƒ¼ãƒ‰ãŒæ›¸ã‘ã‚‹çŠ¶æ…‹ã¨ã—ã¦ã€ç›®çš„ã«å¯¾ã—ã¦æœ€é©ã®è§£ã‚’é¸æŠã§ãã‚‹çŠ¶æ…‹ã§ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚

æœ¬è¨˜äº‹ã§ã¯ã€Google SpreadSheet å´ã‹ã‚‰ Google Apps Script ã‚’ä½¿ã£ã¦ãƒ‡ãƒ¼ã‚¿ã‚’å–ã‚Šå‡ºã™åŸºæœ¬çš„ãªã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ã¦ã¿ã¾ã™ã€‚

## ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’èµ·ç‚¹ã¨ã—ãŸãƒ‡ãƒ¼ã‚¿é€£æº

å‰æã¨ã—ã¦

- demo.pleasanter.org ã«ç™»éŒ²ã—ã¦ãã ã•ã„
- ç®¡ç†è€…ãƒ¦ãƒ¼ã‚¶ã§ãƒ‡ãƒ¢ã‚µã‚¤ãƒˆã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ API ã‚­ãƒ¼ã‚’ä½œæˆã—ã¦å–å¾—ã—ã¦ãã ã•ã„
- "äº¤é€šè²»æ¸…ç®—ã®ä¾‹"ã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚’ã—ã¾ã—ãŸãŒã€é©å½“ãªã‚µã‚¤ãƒˆã®ã‚µã‚¤ãƒˆ ID ã‚’ç¢ºèªã—ã¦ãã ã•ã„

### ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿å‡ºã™

- Google SpreadSheet ã‚’ä½œæˆã—ã€æ‹¡å¼µæ©Ÿèƒ½ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ã€ŒApps Scriptã€ã‚’é¸æŠã—ã¦ã‚¨ãƒ‡ã‚£ã‚¿ã‚’é–‹ãã¾ã™ã€‚
- ã‚³ãƒ¼ãƒ‰.gs ã«ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’è²¼ã‚Šã¤ã‘ã¾ã™ã€‚
- apikey ã¨ siteId ã‚’å‰æã§ç¢ºèªã—ãŸã‚‚ã®ã«æ›¸ãæ›ãˆã¦ä¿å­˜ã—ã¾ã™ã€‚
- ã€Œãƒ‡ãƒãƒƒã‚°ã€ã®å³ã«ã‚ã‚‹ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‹ã‚‰ main ã‚’é¸æŠã—ã€ã€Œå®Ÿè¡Œã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™ã€‚

```javascript
const apikey = ''; //apikey ã‚’è¨˜å…¥ã—ã¾ã™
const host = 'https://demo.pleasanter.org';
const siteId = 123456; //ã‚µã‚¤ãƒˆ ID ã‚’è¨˜å…¥ã—ã¾ã™

const controlDefiner = (control, act, id) => {
  const controlName = normalizeControl(control, act, id);
  const actionName = normalizeAction(control, act);
  if (controlName === '' || actionName === '')
    throw new Error(`${control} ${act} is not implemented`);
  return { controller: controlName, action: actionName };
};
const normalizeControl = (control, act, id) => {
  switch (control) {
    case 'records':
    case 'record':
    case 'site':
    case 'table':
      if (act[0] === 'u' || act[0] === 'd') {
        return 'items';
      }
      return `items/${id}`;
    case 'users':
    case 'user':
      return 'users';
    case 'depts':
    case 'dept':
      return 'depts';
    case 'groups':
    case 'group':
      return 'groups;';
    default:
      return '';
  }
};
const normalizeAction = (target, action) => {
  switch (target) {
    case 'site':
    case 'table':
      return `${action}site`;
    case 'records':
    case 'record':
    case 'users':
    case 'user':
    case 'depts':
    case 'dept':
    case 'groups':
    case 'group':
      return action;
    default:
      return '';
  }
};

const urlBuilder = (host, control, act, id) => {
  const { controller, action } = controlDefiner(control, act, id);
  switch (action[0]) {
    case 'u':
    case 'd':
      return `${host}/api/${controller}/${id}/${action}`;
    case 'c':
    case 'g':
    default:
      return `${host}/api/${controller}/${action}`;
  }
};
const post = (host, control, act, id) => {
  const param = {
    contentType: 'application/json',
    method: 'post',
    payload: JSON.stringify({ ApiVersion: 1.1, ApiKey: apikey }),
    muteHttpExceptions: true,
  };
  const url = urlBuilder(host, control, act, id);
  const res = UrlFetchApp.fetch(url, param);
  if (res.getResponseCode() !== 200) return [];
  return JSON.parse(res.getContentText()).Response.Data;
};
const flatten = (data, parent = {}) =>
  Object.entries(data).reduce(
    (a, c) =>
      c[0].startsWith('Attachments')
        ? a
        : c[0].endsWith('Hash')
        ? flatten(c[1], a)
        : { ...a, [c[0]]: c[1] },
    parent,
  );
const headerFromFirst = (data) => Object.keys(data[0]);
const writeToSheet = (data, sheetName = 'ã‚·ãƒ¼ãƒˆ1') => {
  const sheet =
    sheetName === undefined
      ? SpreadsheetApp.getActiveSheet()
      : SpreadsheetApp.getActive().getSheetByName(sheetName);
  if (sheet === undefined || sheet === null) {
    console.error(`no sheet ${sheetName}`);
    return;
  }
  if (data.length < 1) return;
  sheet.clearContents();
  const rows = data.map(flatten);
  const header = headerFromFirst(rows);
  const values = [header].concat(rows.map((r) => header.map((c) => r[c])));
  sheet.getRange(1, 1, values.length, header.length).setValues(values);
};
const main = () => {
  writeToSheet(post(host, 'records', 'get', siteId));
};
```

## ãŠã‚ã‚Šã«

- ä»Šå›ã¯ã²ã¨ã¾ãšãƒ‡ãƒ¼ã‚¿ã‚’å–ã‚Šå‡ºã™ã ã‘ã¨ãªã‚Šã¾ã—ãŸã€‚
  - ã¨ã‚Šã‚ãˆãš users ã¨ depts ã‚‚å–å¾—ã§ãã‚‹ã“ã¨ã¾ã§ã¯ç¢ºèªã—ã¦ã„ã¾ã™ã€‚
  - å‹•ã‹ãªã„ã€ãªã©ã‚ã‚Šã¾ã—ãŸã‚‰ã‚³ãƒ¡ãƒ³ãƒˆãã ã•ã‚Œã°ãƒ™ã‚¹ãƒˆã‚¨ãƒ•ã‚©ãƒ¼ãƒˆã§å¯¾å¿œã—ã¾ã™ã€‚
- æ›¸ãè¾¼ã¿ã‚„å…·ä½“çš„ãªåˆ©ç”¨ã«ç¹‹ãŒã‚‹ç™ºå±•ã¯ã¾ãŸè€ƒãˆãŸã„ã¨æ€ã„ã¾ã™ã€‚
