---
title: 'IO#puts ã®æŒ™å‹•'
emoji: 'ðŸ”–'
type: 'tech' # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ['ruby']
published: false
---

## ã¾ã¨ã‚

- æœ«å°¾ãŒ "\n"(0x0a) ã§ãªã„å ´åˆã€æš—é»™ã« "\n" ã‚’è¶³ã™ã€‚
  - ç’°å¢ƒã«ä¾å­˜ã—ãªã„å‹•ä½œ
  - Cf. [Environment.NewLine](https://learn.microsoft.com/ja-jp/dotnet/api/system.environment.newline?view=net-7.0)

### å‹•ä½œç¢ºèª

#### Rails Console ã§æ›¸ãè¾¼ã¿ã‚’ã™ã‚‹

```ruby
irb(main):029:0> f = File.open("1rn.txt",'w+b')
=> #<File:1rn.txt>
irb(main):031:0> f.puts "1\r\n"
=> nil
irb(main):032:0> f.close
=> nil
irb(main):033:0> f = File.open("1r.txt",'w+b')
=> #<File:1r.txt>
irb(main):034:0> f.puts "1\r"
=> nil
irb(main):035:0> f.close
=> nil
irb(main):036:0> f = File.open("1n.txt",'w+b')
=> #<File:1n.txt>
irb(main):037:0> f.puts "1\n"
=> nil
irb(main):038:0> f.close
=> nil
irb(main):039:0> f = File.open("1.txt",'w+b')
=> #<File:1.txt>
irb(main):040:0> f.puts "1"
=> nil
irb(main):041:0> f.close
=> nil
```

#### æ›¸ãè¾¼ã¿ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªã™ã‚‹

```sh
â¯  xxd 1rn.txt
00000000: 310d 0a                                  1..
â¯  xxd 1r.txt
00000000: 310d 0a                                  1..
â¯  xxd 1n.txt
00000000: 310a                                     1.
â¯  xxd 1.txt
00000000: 310a                                     1.
```

â†’ "1\r" ã‚„ "1" ã ã‘æ›¸ãè¾¼ã‚“ã å ´åˆ "\n" ãŒè¶³ã•ã‚Œã¦ã„ã‚‹
â†’ "\n" ã§çµ‚ã‚ã£ã¦ã„ã‚‹å ´åˆã¯è¶³ã•ã‚Œã¦ãªã„

### ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰

- File#puts ã¯ IO ã‚’ç¶™æ‰¿

https://docs.ruby-lang.org/ja/latest/class/File.html

> IO ã‹ã‚‰ç¶™æ‰¿ã—ã¦ã„ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰
> puts

- IO#puts

https://github.com/ruby/ruby/blob/master/io.c#L15366

```c
    rb_define_global_function("puts", rb_f_puts, -1);
```

https://github.com/ruby/ruby/blob/11f33ba6204909ebbb142283bc9395d3343db28e/io.c#L8951-L8958

```c
rb_f_puts(int argc, VALUE *argv, VALUE recv)
{
    VALUE r_stdout = rb_ractor_stdout();
    if (recv == r_stdout) {
        return rb_io_puts(argc, argv, recv);
    }
    return forward(r_stdout, rb_intern("puts"), argc, argv);
}
```

https://github.com/ruby/ruby/blob/11f33ba6204909ebbb142283bc9395d3343db28e/io.c#L8928-L8933

```c
        else {
            args[n++] = line;
            if (!rb_str_end_with_asciichar(line, '\n')) {
                args[n++] = rb_default_rs;
            }
        }
```

https://github.com/ruby/ruby/blob/master/io.c#L15447

```c
    rb_default_rs = rb_fstring_lit("\n"); /* avoid modifying RS_default */
```

â–¡
