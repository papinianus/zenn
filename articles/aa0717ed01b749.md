---
title: 'Pleasanter x Google é€£æº:ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’æ›¸ãè¾¼ã‚€(å‰Šé™¤ç·¨)'
emoji: 'ğŸŠ'
type: 'tech' # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ['googlespreadsheet', 'pleasanter']
published: true
---

- [2022 å€‹äººã‚¢ãƒ‰ãƒ™ãƒ³ãƒˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼](https://qiita.com/advent-calendar/2022/papinianus) ã®è¨˜äº‹ã§ã™ã€‚
- å½“æ—¥ä¸­ã«å…¬é–‹ã§ãã¾ã›ã‚“ã§ã—ãŸ

## ã‚´ãƒ¼ãƒ«

- Google SpreadSheet ã§ç·¨é›†ã—ãŸå†…å®¹ã‚’ Pleasanter ã«é©ç”¨ã™ã‚‹
- åŠ›åŠã°ãšã€ä»Šå›ã¯å‰Šé™¤ã®ã¿å¯¾å¿œ

  - ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ä¸Šæ‰‹ãã ã›ãªã‹ã£ãŸã®ã§ã€å‰Šé™¤åˆ—ã«ã¯ `1` ãªã©ã‚’å…¥ã‚Œã‚‹æƒ³å®š

- èª­ã¿å–ã‚Šã«ã¤ã„ã¦ã®[å‰ã®è¨˜äº‹](https://zenn.dev/ulpianus/articles/0c75008f5fa87d)ã‚’ä¸‹æ•·ã«ã—ã¦ã„ã¾ã™(ã‚³ãƒ¼ãƒ‰.gs ã®éƒ¨åˆ†)

## ã‚³ãƒ¼ãƒ‰

- ä½¿ã„ã‹ãŸã¨ã—ã¦ `main` ã‚’å®Ÿè¡Œã—ã¦ã€ä¸€æ—¦ã‚·ãƒ¼ãƒˆã«å–ã‚Šè¾¼ã¾ã‚Œã¦ã„ã‚‹çŠ¶æ…‹ã§ã€å‰Šé™¤åˆ—ã« `1` ã¨ã‹ãã¨ãƒ‡ãƒ¼ã‚¿ãŒæ¶ˆã•ã‚Œã¾ã™ã€‚
- ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã¯æ¶ˆã—ã¦ã„ã¾ã›ã‚“ã€‚
  - ã“ã“ã§ã¯ã€æœ€æ–°ã®ãƒ‡ãƒ¼ã‚¿ã¯ã€éƒ½åº¦å–ã‚Šå‡ºã™æƒ³å®šã®ãŸã‚ã§ã™ã€‚

### ã‚³ãƒ¼ãƒ‰.gs

èª­ã¿å–ã‚Šã®è¨˜äº‹ã‹ã‚‰ã®å¤‰æ›´ç‚¹ã¨ã—ã¦ã€

1. å‰Šé™¤åˆ—ã‚’è¿½åŠ 
2. post é–¢æ•°ã§ã€ã‚¤ãƒ³ãƒ—ãƒƒãƒˆç”¨ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å—ã‘ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ã—ãŸ(ä»Šå¾Œã®æ–°è¦ãƒ»ç·¨é›†ã‚’è¦‹æ®ãˆã¦ã®å¯¾å¿œ)

```javascript
const apikey = ''; //apikey ã‚’è¨˜å…¥ã—ã¾ã™
const host = 'https://demo.pleasanter.org';
const siteId = 123456; //ã‚µã‚¤ãƒˆ ID ã‚’è¨˜å…¥ã—ã¾ã™

const main = () => {
  writeToSheet(post(host, 'records', 'get', siteId));
};

/**
 * ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’æ±ºå®šã™ã‚‹ãŸã‚ã®ãƒ˜ãƒ«ãƒ‘
 * @param control:string // records ãƒ‡ãƒ¼ã‚¿ãƒ¬ã‚³ãƒ¼ãƒ‰, site ã‚µã‚¤ãƒˆ, users ãƒ¦ãƒ¼ã‚¶, depts çµ„ç¹”, groups ã‚°ãƒ«ãƒ¼ãƒ—
 * @param act:string // get delete update create
 * @param id:number // (ãƒ¬ã‚³ãƒ¼ãƒ‰ãŠã‚ˆã³ã‚µã‚¤ãƒˆã‚’æ“ä½œã™ã‚‹ã¨ã)è¦ªã® id
 * */
const controlDefiner = (control, act, id) => {
  const controlName = normalizeControl(control, act, id);
  const actionName = normalizeAction(control, act);
  if (controlName === '' || actionName === '')
    throw new Error(`${control} ${act} is not implemented`);
  return { controller: controlName, action: actionName };
};
const normalizeControl = (control, act, id) => {
  switch (control) {
    case 'records':
    case 'record':
    case 'site':
    case 'table':
      if (act[0] === 'u' || act[0] === 'd') {
        return 'items';
      }
      return `items/${id}`;
    case 'users':
    case 'user':
      return 'users';
    case 'depts':
    case 'dept':
      return 'depts';
    case 'groups':
    case 'group':
      return 'groups;';
    default:
      return '';
  }
};
const normalizeAction = (target, action) => {
  switch (target) {
    case 'site':
    case 'table':
      return `${action}site`;
    case 'records':
    case 'record':
    case 'users':
    case 'user':
    case 'depts':
    case 'dept':
    case 'groups':
    case 'group':
      return action;
    default:
      return '';
  }
};
const urlBuilder = (host, control, act, id) => {
  const { controller, action } = controlDefiner(control, act, id);
  switch (action[0]) {
    case 'u':
    case 'd':
      return `${host}/api/${controller}/${id}/${action}`;
    case 'c':
    case 'g':
    default:
      return `${host}/api/${controller}/${action}`;
  }
};
//

// ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã€‚ãƒšãƒ¼ã‚¸ãƒ³ãƒ³ã‚°ãªã—
const post = (host, control, act, id, body = {}) => {
  console.log(body);
  const param = {
    contentType: 'application/json',
    method: 'post',
    payload: JSON.stringify({ ...body, ApiVersion: 1.1, ApiKey: apikey }),
    muteHttpExceptions: true,
  };
  const url = urlBuilder(host, control, act, id);
  const res = UrlFetchApp.fetch(url, param);
  console.log(JSON.parse(res.getContentText()));
  if (res.getResponseCode() !== 200) return [];
  return JSON.parse(res.getContentText()).Response?.Data;
};
// éšå±¤åŒ–ã—ã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿é …ç›®ã‚’å±•é–‹ã™ã‚‹ã€‚æ·»ä»˜ã¯é™¤å¤–
const flatten = (data, parent = {}) =>
  Object.entries(data).reduce(
    (a, c) =>
      c[0].startsWith('Attachments')
        ? a
        : c[0].endsWith('Hash')
        ? flatten(c[1], a)
        : { ...a, [c[0]]: c[1] },
    parent,
  );
// ãƒ‡ãƒ¼ã‚¿é …ç›®ã‹ã‚‰ãƒ˜ãƒƒãƒ€è¡Œã‚’ä½œã‚‹
const headerFromFirst = (data) => Object.keys(data[0]);
const objectToArray = (data, appendCheck = 'å‰Šé™¤') => {
  const header =
    appendCheck === undefined
      ? headerFromFirst(data)
      : [appendCheck].concat(headerFromFirst(data));
  return [header].concat(data.map((r) => header.map((c) => r[c])));
};

// ãƒ‡ãƒ¼ã‚¿ã‚’ã‚·ãƒ¼ãƒˆã«æ›¸ãè¾¼ã‚€
const writeToSheet = (data, sheetName = 'ã‚·ãƒ¼ãƒˆ1') => {
  const sheet =
    sheetName === undefined
      ? SpreadsheetApp.getActiveSheet()
      : SpreadsheetApp.getActive().getSheetByName(sheetName);
  if (sheet === undefined || sheet === null) {
    console.error(`no sheet ${sheetName}`);
    return;
  }
  if (data.length < 1) return;
  sheet.clearContents();
  const rows = data.map(flatten);
  const values = objectToArray(rows);
  sheet.getRange(1, 1, values.length, values[0].length).setValues(values);
};
```

### OnEdit.gs

- OnEdit ã‚’ãƒˆãƒªã‚¬ãƒ¼ã¨ã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™
  - ã‚·ãƒ³ãƒ—ãƒ«ãƒˆãƒªã‚¬ãƒ¼ã ã¨ fetch ãŒã§ããªã„ãŸã‚ã§ã™

```javascript
const onEdit = (e) => {
  if (e.authMode.toString() === 'LIMITED') return;
  const sheet = e.range.getSheet();
  const data = sheet.getDataRange().getValues();
  const header = data[0];
  const idColName = header.includes('ResultId') ? 'ResultId' : 'IssueId';
  const idCol = header.findIndex((e) => e === idColName);
  const colNums = range(e.range.getColumn() - 1, e.range.getWidth());
  if (!colNums.includes(idCol)) {
    colNums.push(idCol);
  }
  const rowNums = range(e.range.getRow() - 1, e.range.getHeight());
  if (!rowNums.includes(0)) {
    rowNums.push(0);
  }
  const edited = data
    .filter((_, i) => rowNums.includes(i))
    .map((r) => r.filter((_, i) => colNums.includes(i)));
  handler(edited, idColName);
};
const handler = (data, idColName) => {
  const idCol = data[0].findIndex((e) => e === idColName);
  handleDelete(filterDelete(data, idCol));
};
const filterDelete = (data, idCol) => {
  const idxDel = data[0].findIndex((e) => e === 'å‰Šé™¤');
  if (idxDel === -1) return [];
  return data.slice(1).map((e) => e[idCol]);
};
const handleDelete = (ids) => {
  ids.forEach((e) => post(host, 'records', 'delete', e));
};
const range = (start, len) => Array.from({ length: len }, (_, i) => start + i);
```

## ã•ã„ã”ã«

ã²ã¨ã¾ãšã€ä»Šå›ã¯ã“ã‚Œã¾ã§ã€‚
å¼•ãç¶šãã€æ›´æ–°ã¨æ–°è¦ä½œæˆã‚’å¯¾å¿œäºˆå®šã§ã™ã€‚
