---
title: 'Pleasanter x Google 連携:スプレッドシートからデータを書き込む(削除編)'
emoji: '🍊'
type: 'tech' # tech: 技術記事 / idea: アイデア
topics: ['googlespreadsheet', 'pleasanter']
published: false
---

[2022 個人アドベントカレンダー](https://qiita.com/advent-calendar/2022/papinianus) の記事です。

## ゴール

- Google SpreadSheet で編集した内容を Pleasanter に適用する
- 力及ばず、今回は削除のみ対応

  - チェックボックスを上手くだせなかったので、削除列には `1` などを入れる想定

- 読み取りについての[前の記事](https://zenn.dev/ulpianus/articles/0c75008f5fa87d)を下敷にしています(コード.gs の部分)

## コード

- コード.gs

読み取りの記事からの変更点として、

1. 削除列を追加
2. post 関数で、インプット用パラメータを受けられるようにした(今後の新規・編集を見据えての対応)

```javascript
const apikey =
  'b20fdc59f4eacd244070a1527b46b67fbf0c504a900053b556f583dde85f986adea29c688b48537ffe3b44a43fd2e943198886ae15144829aa066b5a46aad82b';
const host = 'https://demo.pleasanter.org';

const siteId = 6257928; //交通費清算の例 を想定
const main = () => {
  writeToSheet(post(host, 'records', 'get', siteId));
};

/**
 * エンドポイントを決定するためのヘルパ
 * @param control:string // records データレコード, site サイト, users ユーザ, depts 組織, groups グループ
 * @param act:string // get delete update create
 * @param id:number // (レコードおよびサイトを操作するとき)親の id
 * */
const controlDefiner = (control, act, id) => {
  const controlName = normalizeControl(control, act, id);
  const actionName = normalizeAction(control, act);
  if (controlName === '' || actionName === '')
    throw new Error(`${control} ${act} is not implemented`);
  return { controller: controlName, action: actionName };
};
const normalizeControl = (control, act, id) => {
  switch (control) {
    case 'records':
    case 'record':
    case 'site':
    case 'table':
      if (act[0] === 'u' || act[0] === 'd') {
        return 'items';
      }
      return `items/${id}`;
    case 'users':
    case 'user':
      return 'users';
    case 'depts':
    case 'dept':
      return 'depts';
    case 'groups':
    case 'group':
      return 'groups;';
    default:
      return '';
  }
};
const normalizeAction = (target, action) => {
  switch (target) {
    case 'site':
    case 'table':
      return `${action}site`;
    case 'records':
    case 'record':
    case 'users':
    case 'user':
    case 'depts':
    case 'dept':
    case 'groups':
    case 'group':
      return action;
    default:
      return '';
  }
};
const urlBuilder = (host, control, act, id) => {
  const { controller, action } = controlDefiner(control, act, id);
  switch (action[0]) {
    case 'u':
    case 'd':
      return `${host}/api/${controller}/${id}/${action}`;
    case 'c':
    case 'g':
    default:
      return `${host}/api/${controller}/${action}`;
  }
};
//

// データを取得。ページンングなし
const post = (host, control, act, id, body = {}) => {
  console.log(body);
  const param = {
    contentType: 'application/json',
    method: 'post',
    payload: JSON.stringify({ ...body, ApiVersion: 1.1, ApiKey: apikey }),
    muteHttpExceptions: true,
  };
  const url = urlBuilder(host, control, act, id);
  const res = UrlFetchApp.fetch(url, param);
  console.log(JSON.parse(res.getContentText()));
  if (res.getResponseCode() !== 200) return [];
  return JSON.parse(res.getContentText()).Response?.Data;
};
// 階層化しているデータ項目を展開する。添付は除外
const flatten = (data, parent = {}) =>
  Object.entries(data).reduce(
    (a, c) =>
      c[0].startsWith('Attachments')
        ? a
        : c[0].endsWith('Hash')
        ? flatten(c[1], a)
        : { ...a, [c[0]]: c[1] },
    parent,
  );
// データ項目からヘッダ行を作る
const headerFromFirst = (data) => Object.keys(data[0]);
const objectToArray = (data, appendCheck = '削除') => {
  const header =
    appendCheck === undefined
      ? headerFromFirst(data)
      : [appendCheck].concat(headerFromFirst(data));
  return [header].concat(data.map((r) => header.map((c) => r[c])));
};

// データをシートに書き込む
const writeToSheet = (data, sheetName = 'シート1') => {
  const sheet =
    sheetName === undefined
      ? SpreadsheetApp.getActiveSheet()
      : SpreadsheetApp.getActive().getSheetByName(sheetName);
  if (sheet === undefined || sheet === null) {
    console.error(`no sheet ${sheetName}`);
    return;
  }
  if (data.length < 1) return;
  sheet.clearContents();
  const rows = data.map(flatten);
  const values = objectToArray(rows);
  sheet.getRange(1, 1, values.length, values[0].length).setValues(values);
};
```
