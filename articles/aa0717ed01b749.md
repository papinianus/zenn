---
title: 'Pleasanter x Google é€£æº:ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’æ›¸ãè¾¼ã‚€(å‰Šé™¤ç·¨)'
emoji: 'ðŸŠ'
type: 'tech' # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ['googlespreadsheet', 'pleasanter']
published: false
---

[2022 å€‹äººã‚¢ãƒ‰ãƒ™ãƒ³ãƒˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼](https://qiita.com/advent-calendar/2022/papinianus) ã®è¨˜äº‹ã§ã™ã€‚

## ã‚´ãƒ¼ãƒ«

- Google SpreadSheet ã§ç·¨é›†ã—ãŸå†…å®¹ã‚’ Pleasanter ã«é©ç”¨ã™ã‚‹
- åŠ›åŠã°ãšã€ä»Šå›žã¯å‰Šé™¤ã®ã¿å¯¾å¿œ

  - ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ä¸Šæ‰‹ãã ã›ãªã‹ã£ãŸã®ã§ã€å‰Šé™¤åˆ—ã«ã¯ `1` ãªã©ã‚’å…¥ã‚Œã‚‹æƒ³å®š

- èª­ã¿å–ã‚Šã«ã¤ã„ã¦ã®[å‰ã®è¨˜äº‹](https://zenn.dev/ulpianus/articles/0c75008f5fa87d)ã‚’ä¸‹æ•·ã«ã—ã¦ã„ã¾ã™(ã‚³ãƒ¼ãƒ‰.gs ã®éƒ¨åˆ†)

## ã‚³ãƒ¼ãƒ‰

- ã‚³ãƒ¼ãƒ‰.gs

èª­ã¿å–ã‚Šã®è¨˜äº‹ã‹ã‚‰ã®å¤‰æ›´ç‚¹ã¨ã—ã¦ã€

1. å‰Šé™¤åˆ—ã‚’è¿½åŠ 
2. post é–¢æ•°ã§ã€ã‚¤ãƒ³ãƒ—ãƒƒãƒˆç”¨ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å—ã‘ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ã—ãŸ(ä»Šå¾Œã®æ–°è¦ãƒ»ç·¨é›†ã‚’è¦‹æ®ãˆã¦ã®å¯¾å¿œ)

```javascript
const apikey =
  'b20fdc59f4eacd244070a1527b46b67fbf0c504a900053b556f583dde85f986adea29c688b48537ffe3b44a43fd2e943198886ae15144829aa066b5a46aad82b';
const host = 'https://demo.pleasanter.org';

const siteId = 6257928; //äº¤é€šè²»æ¸…ç®—ã®ä¾‹ ã‚’æƒ³å®š
const main = () => {
  writeToSheet(post(host, 'records', 'get', siteId));
};

/**
 * ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’æ±ºå®šã™ã‚‹ãŸã‚ã®ãƒ˜ãƒ«ãƒ‘
 * @param control:string // records ãƒ‡ãƒ¼ã‚¿ãƒ¬ã‚³ãƒ¼ãƒ‰, site ã‚µã‚¤ãƒˆ, users ãƒ¦ãƒ¼ã‚¶, depts çµ„ç¹”, groups ã‚°ãƒ«ãƒ¼ãƒ—
 * @param act:string // get delete update create
 * @param id:number // (ãƒ¬ã‚³ãƒ¼ãƒ‰ãŠã‚ˆã³ã‚µã‚¤ãƒˆã‚’æ“ä½œã™ã‚‹ã¨ã)è¦ªã® id
 * */
const controlDefiner = (control, act, id) => {
  const controlName = normalizeControl(control, act, id);
  const actionName = normalizeAction(control, act);
  if (controlName === '' || actionName === '')
    throw new Error(`${control} ${act} is not implemented`);
  return { controller: controlName, action: actionName };
};
const normalizeControl = (control, act, id) => {
  switch (control) {
    case 'records':
    case 'record':
    case 'site':
    case 'table':
      if (act[0] === 'u' || act[0] === 'd') {
        return 'items';
      }
      return `items/${id}`;
    case 'users':
    case 'user':
      return 'users';
    case 'depts':
    case 'dept':
      return 'depts';
    case 'groups':
    case 'group':
      return 'groups;';
    default:
      return '';
  }
};
const normalizeAction = (target, action) => {
  switch (target) {
    case 'site':
    case 'table':
      return `${action}site`;
    case 'records':
    case 'record':
    case 'users':
    case 'user':
    case 'depts':
    case 'dept':
    case 'groups':
    case 'group':
      return action;
    default:
      return '';
  }
};
const urlBuilder = (host, control, act, id) => {
  const { controller, action } = controlDefiner(control, act, id);
  switch (action[0]) {
    case 'u':
    case 'd':
      return `${host}/api/${controller}/${id}/${action}`;
    case 'c':
    case 'g':
    default:
      return `${host}/api/${controller}/${action}`;
  }
};
//

// ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã€‚ãƒšãƒ¼ã‚¸ãƒ³ãƒ³ã‚°ãªã—
const post = (host, control, act, id, body = {}) => {
  console.log(body);
  const param = {
    contentType: 'application/json',
    method: 'post',
    payload: JSON.stringify({ ...body, ApiVersion: 1.1, ApiKey: apikey }),
    muteHttpExceptions: true,
  };
  const url = urlBuilder(host, control, act, id);
  const res = UrlFetchApp.fetch(url, param);
  console.log(JSON.parse(res.getContentText()));
  if (res.getResponseCode() !== 200) return [];
  return JSON.parse(res.getContentText()).Response?.Data;
};
// éšŽå±¤åŒ–ã—ã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿é …ç›®ã‚’å±•é–‹ã™ã‚‹ã€‚æ·»ä»˜ã¯é™¤å¤–
const flatten = (data, parent = {}) =>
  Object.entries(data).reduce(
    (a, c) =>
      c[0].startsWith('Attachments')
        ? a
        : c[0].endsWith('Hash')
        ? flatten(c[1], a)
        : { ...a, [c[0]]: c[1] },
    parent,
  );
// ãƒ‡ãƒ¼ã‚¿é …ç›®ã‹ã‚‰ãƒ˜ãƒƒãƒ€è¡Œã‚’ä½œã‚‹
const headerFromFirst = (data) => Object.keys(data[0]);
const objectToArray = (data, appendCheck = 'å‰Šé™¤') => {
  const header =
    appendCheck === undefined
      ? headerFromFirst(data)
      : [appendCheck].concat(headerFromFirst(data));
  return [header].concat(data.map((r) => header.map((c) => r[c])));
};

// ãƒ‡ãƒ¼ã‚¿ã‚’ã‚·ãƒ¼ãƒˆã«æ›¸ãè¾¼ã‚€
const writeToSheet = (data, sheetName = 'ã‚·ãƒ¼ãƒˆ1') => {
  const sheet =
    sheetName === undefined
      ? SpreadsheetApp.getActiveSheet()
      : SpreadsheetApp.getActive().getSheetByName(sheetName);
  if (sheet === undefined || sheet === null) {
    console.error(`no sheet ${sheetName}`);
    return;
  }
  if (data.length < 1) return;
  sheet.clearContents();
  const rows = data.map(flatten);
  const values = objectToArray(rows);
  sheet.getRange(1, 1, values.length, values[0].length).setValues(values);
};
```
